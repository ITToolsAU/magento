jpsType: install
jpsVersion: '1.1'
name: Magento Standalone

globals:
  DB_USER: ${settings.db_user}
  DB_PASS: ${settings.db_pass}
  ADMIN_PASS: ${settings.admin_pass}
  MAGENTO_VERSION: ${settings.magento_version}
  PROTOCOL: ${settings.protocol}
  SCRIPTS_PATH: https://raw.githubusercontent.com/jelastic-jps/magento-cluster/master/scripts
  CONFIGS_PATH: https://raw.githubusercontent.com/jelastic-jps/magento-cluster/master/configs

skipNodeEmails: true
nodes:
  - nodeType: nginxphp-dockerized
    count: 1
    cloudlets: 16
    nodeGroup: cp
    env:
      SERVER_WEBROOT: /var/www/webroot/ROOT

  - nodeType: mariadb-dockerized
    tag: 10.3.16
    count: 1
    cloudlets: 8
    nodeGroup: sqldb

onInstall:
    - createDb
    - deployMagento
    - setupMagento

actions:
  createDb:
    - cmd [sqldb]: |-
        wget https://raw.githubusercontent.com/jelastic-jps/mysql-cluster/master/scripts/setupUser.sh -O ~/setupUser.sh &>> /var/log/run.log
        bash ~/setupUser.sh ${globals.DB_USER} ${globals.DB_PASS} &>> /var/log/run.log
        mysql -u${globals.DB_USER} -p${globals.DB_PASS} -e "CREATE DATABASE IF NOT EXISTS magento;"
      user: root

  deployMagento:
    - if (/61ae85fbcfc249b4e63bd38efbb8945f/.test("${globals.MAGENTO_VERSION}")):
      - deploy:
          archive: ${settings.magento_version}
          name: Magento-CE-1.9.4.tar.bz2
          context: ROOT
    - if (/cd1bdcd50edf11ceda77836881cd35e9/.test("${globals.MAGENTO_VERSION}")):
      - deploy:
          archive: ${settings.magento_version}
          name: Magento-CE-2.3.1.tar.bz2
          context: ROOT

  setupMagento:
    - if (/61ae85fbcfc249b4e63bd38efbb8945f/.test("${globals.MAGENTO_VERSION}")):
        cmd[cp]:
          - wget ${globals.CONFIGS_PATH}/nginx/site-default-mg19.conf -O /etc/nginx/conf.d/site-default.conf
          - wget ${globals.CONFIGS_PATH}/nginx/nginx.conf -O /etc/nginx/nginx.conf
          - wget ${globals.CONFIGS_PATH}/php/extensions.ini -O /etc/php.d/extensions.ini;
          - sudo /etc/init.d/nginx restart;
          - wget ${globals.SCRIPTS_PATH}/setupMG19.sh -O /tmp/setupMG19.sh && bash -x /tmp/setupMG19.sh
            ${globals.DB_USER} ${globals.DB_PASS} DB magento ${globals.ADMIN_PASS}
            /var/www/webroot/ROOT ${env.url} ${user.email} &>> /var/log/run.log

    - if (/cd1bdcd50edf11ceda77836881cd35e9/.test("${globals.MAGENTO_VERSION}")):
        cmd[cp]:
          - wget ${globals.CONFIGS_PATH}/nginx/site-default-mg2.conf -O /etc/nginx/conf.d/site-default.conf
          - wget ${globals.CONFIGS_PATH}/nginx/nginx.conf -O /etc/nginx/nginx.conf
          - wget ${globals.CONFIGS_PATH}/php/extensions.ini -O /etc/php.d/extensions.ini;
          - sudo /etc/init.d/nginx restart;
          - wget ${globals.SCRIPTS_PATH}//setupMG2.sh -O /tmp/setupMG2.sh && bash -x /tmp/setupMG2.sh
            ${globals.DB_USER} ${globals.DB_PASS} DB magento ${globals.ADMIN_PASS}
            /var/www/webroot/ROOT ${env.url} ${user.email} &>> /var/log/run.log
