jpsType: install
jpsVersion: '1.5.2'
id: magento
name: Magento
logo: https://raw.githubusercontent.com/jelastic-jps/magento/master/magento/images/magento.png
categories:
    - apps/e-commerce
    - apps/sales-and-marketing
homepage: http://www.magentocommerce.com/
description:
  en: Magento is the eCommerce software and platform trusted by the world's leading
      brands. Grow your online business with Magento!

baseUrl: https://raw.githubusercontent.com/sych74/magento/master

settings:
  fields:
    name: magento_version
    caption: Magento version
    type: list
    values:
      https://download.jelastic.com/public.php?service=files&t=cd1bdcd50edf11ceda77836881cd35e9&download: Magento CE 2.3.x
      https://download.jelastic.com/public.php?service=files&t=61ae85fbcfc249b4e63bd38efbb8945f&download: Magento CE 1.9.4.x
    default: https://download.jelastic.com/public.php?service=files&t=cd1bdcd50edf11ceda77836881cd35e9&download

globals:
  DB_USER: jelastic-${fn.random}
  DB_PASS: ${fn.password(20)}
  ADMIN_PASSWD: ${fn.password(20)}
  CONFIGS_PATH: https://raw.githubusercontent.com/sych74/magento-cluster/master

ssl: false
nodes:
  - nodeType: litespeedphp
    tag: 5.3.7-php-7.2.18
    count: 1
    cloudlets: 16
    nodeGroup: cp
    links: sqldb:DB

  - nodeType: mysql
    count: 1
    cloudlets: 8
    nodeGroup: sqldb

onInstall:
    - createDb
    - deployMagento
    - setupMagento

actions:
  createDb:
    - cmd [sqldb]: |-
        wget https://raw.githubusercontent.com/jelastic-jps/mysql-cluster/master/scripts/setupUser.sh -O ~/setupUser.sh &>> /var/log/run.log
        bash ~/setupUser.sh ${globals.DB_USER} ${globals.DB_PASS} &>> /var/log/run.log
        mysql -u${globals.DB_USER} -p${globals.DB_PASS} -e "CREATE DATABASE IF NOT EXISTS magento;"
      user: root

  deployMagento:
    - if (/61ae85fbcfc249b4e63bd38efbb8945f/.test("${settings.magento_version}")):
      - deploy:
          archive: ${settings.magento_version}
          name: Magento-CE-1.9.4.tar.bz2
          context: ROOT
    - if (/cd1bdcd50edf11ceda77836881cd35e9/.test("${settings.magento_version}")):
      - deploy:
          archive: ${settings.magento_version}
          name: Magento-CE-2.3.1.tar.bz2
          context: ROOT

  setupMagento:
    - if (/61ae85fbcfc249b4e63bd38efbb8945f/.test("${settings.magento_version}")):
        cmd[cp]:
          - wget ${globals.CONFIGS_PATH}/scripts/setupMG19.sh?_r=${fn.random} -O /tmp/setupMG19.sh && bash -x /tmp/setupMG19.sh
            ${globals.DB_USER} ${globals.DB_PASS} DB magento ${globals.ADMIN_PASSWD}
            /var/www/webroot/ROOT ${env.url} ${user.email} &>> /var/log/run.log

    - if (/cd1bdcd50edf11ceda77836881cd35e9/.test("${settings.magento_version}")):
        cmd[cp]:
          - wget ${globals.CONFIGS_PATH}/scripts/setupMG2.sh?_r=${fn.random} -O /tmp/setupMG2.sh && bash -x /tmp/setupMG2.sh
            ${globals.DB_USER} ${globals.DB_PASS} DB magento ${globals.ADMIN_PASSWD}
            /var/www/webroot/ROOT ${env.url} ${user.email} &>> /var/log/run.log

success:
    text: Below you will find your admin panel link, username and password.<br>Admin URL: **[${env.url}index.php/admin/](${env.url}index.php/admin/)**<br>Admin name: **admin** and Password: **${globals.ADMIN_PASSWD}**.<br>To add custom domain name for your Magento installation follow the steps described in our [documentation](http://docs.jelastic.com/custom-domains)
    email: Below you will find your admin panel link, username and password.< br>Admin URL: ${env.url}index.php/admin/<br>Admin name: admin<br>Password: ${globals.ADMIN_PASSWD}<br>To add custom domain name for your Magento installation follow the steps described in our [documentation](http://docs.jelastic.com/custom-domains)
